<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定时任务管理</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-badge {
            font-size: 0.8em;
        }
        .job-actions {
            white-space: nowrap;
        }
        .stats-card {
            border-left: 4px solid;
        }
        .stats-card.running {
            border-left-color: #28a745;
        }
        .stats-card.paused {
            border-left-color: #ffc107;
        }
        .stats-card.total {
            border-left-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <!-- 页面标题 -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-clock"></i> 定时任务管理</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/demo">首页</a></li>
                        <li class="breadcrumb-item active">定时任务管理</li>
                    </ol>
                </nav>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stats-card total">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">总任务数</h6>
                                <h3 class="mb-0" th:text="${jobCount != null ? jobCount : 0}">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-tasks fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card running">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">运行中</h6>
                                <h3 class="mb-0" th:text="${runningCount != null ? runningCount : 0}">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-play-circle fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card paused">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="text-muted">已暂停</h6>
                                <h3 class="mb-0" th:text="${pausedCount != null ? pausedCount : 0}">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-pause-circle fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="row mb-3">
            <div class="col-12">
                <a href="/demo/schedule/add" class="btn btn-primary">
                    <i class="fas fa-plus"></i> 新增任务
                </a>
                <button type="button" class="btn btn-outline-secondary" onclick="refreshJobList()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>
        </div>

        <!-- 错误信息 -->
        <div th:if="${error}" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <span th:text="${error}"></span>
        </div>

        <!-- 任务列表 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-list"></i> 任务列表</h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${jobs != null and !jobs.isEmpty()}">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="jobTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>任务名称</th>
                                            <th>任务组</th>
                                            <th>任务类</th>
                                            <th>Cron表达式</th>
                                            <th>状态</th>
                                            <th>下次执行时间</th>
                                            <th>上次执行时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="job : ${jobs}">
                                            <td>
                                                <strong th:text="${job.jobName}"></strong>
                                                <br>
                                                <small class="text-muted" th:text="${job.description}"></small>
                                            </td>
                                            <td th:text="${job.jobGroup}"></td>
                                            <td>
                                                <code th:text="${job.jobClassName}"></code>
                                            </td>
                                            <td>
                                                <code th:text="${job.cronExpression}"></code>
                                            </td>
                                            <td>
                                                <span th:if="${job.status == 1}" class="badge bg-success status-badge">
                                                    <i class="fas fa-play"></i> 正常
                                                </span>
                                                <span th:if="${job.status == 0}" class="badge bg-warning status-badge">
                                                    <i class="fas fa-pause"></i> 暂停
                                                </span>
                                            </td>
                                            <td>
                                                <span th:if="${job.nextFireTime}" 
                                                      th:text="${#temporals.format(job.nextFireTime, 'MM-dd HH:mm:ss')}"
                                                      class="text-primary"></span>
                                                <span th:unless="${job.nextFireTime}" class="text-muted">-</span>
                                            </td>
                                            <td>
                                                <span th:if="${job.prevFireTime}" 
                                                      th:text="${#temporals.format(job.prevFireTime, 'MM-dd HH:mm:ss')}"
                                                      class="text-info"></span>
                                                <span th:unless="${job.prevFireTime}" class="text-muted">-</span>
                                            </td>
                                            <td class="job-actions">
                                                <!-- 运行按钮 -->
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        th:onclick="'runJob(\'' + ${job.jobName} + '\', \'' + ${job.jobGroup} + '\')'">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                
                                                <!-- 暂停/恢复按钮 -->
                                                <button th:if="${job.status == 1}" type="button" class="btn btn-sm btn-outline-warning" 
                                                        th:onclick="'pauseJob(\'' + ${job.jobName} + '\', \'' + ${job.jobGroup} + '\')'">
                                                    <i class="fas fa-pause"></i>
                                                </button>
                                                <button th:if="${job.status == 0}" type="button" class="btn btn-sm btn-outline-success" 
                                                        th:onclick="'resumeJob(\'' + ${job.jobName} + '\', \'' + ${job.jobGroup} + '\')'">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                
                                                <!-- 编辑按钮 -->
                                                <a th:href="@{'/demo/schedule/edit/' + ${job.jobName} + '/' + ${job.jobGroup}}" 
                                                   class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                
                                                <!-- 删除按钮 -->
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        th:onclick="'deleteJob(\'' + ${job.jobName} + '\', \'' + ${job.jobGroup} + '\')'">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 空状态 -->
                        <div th:if="${jobs == null or jobs.isEmpty()}" class="text-center py-5">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">暂无定时任务</h5>
                            <p class="text-muted">点击上方按钮创建第一个定时任务</p>
                            <a href="/demo/schedule/add" class="btn btn-primary">
                                <i class="fas fa-plus"></i> 创建任务
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 刷新任务列表
        function refreshJobList() {
            location.reload();
        }

        // 运行任务
        function runJob(jobName, jobGroup) {
            if (confirm('确定要立即执行任务"' + jobName + '"吗？')) {
                fetch(`/demo/schedule/api/jobs/${jobName}/${jobGroup}/run`, {
                    method: 'PUT'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('任务执行成功！');
                    } else {
                        alert('任务执行失败：' + data.message);
                    }
                })
                .catch(error => {
                    alert('操作失败：' + error.message);
                });
            }
        }

        // 暂停任务
        function pauseJob(jobName, jobGroup) {
            if (confirm('确定要暂停任务"' + jobName + '"吗？')) {
                fetch(`/demo/schedule/api/jobs/${jobName}/${jobGroup}/pause`, {
                    method: 'PUT'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('任务暂停成功！');
                        location.reload();
                    } else {
                        alert('任务暂停失败：' + data.message);
                    }
                })
                .catch(error => {
                    alert('操作失败：' + error.message);
                });
            }
        }

        // 恢复任务
        function resumeJob(jobName, jobGroup) {
            if (confirm('确定要恢复任务"' + jobName + '"吗？')) {
                fetch(`/demo/schedule/api/jobs/${jobName}/${jobGroup}/resume`, {
                    method: 'PUT'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('任务恢复成功！');
                        location.reload();
                    } else {
                        alert('任务恢复失败：' + data.message);
                    }
                })
                .catch(error => {
                    alert('操作失败：' + error.message);
                });
            }
        }

        // 删除任务
        function deleteJob(jobName, jobGroup) {
            if (confirm('确定要删除任务"' + jobName + '"吗？此操作不可撤销！')) {
                fetch(`/demo/schedule/api/jobs/${jobName}/${jobGroup}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('任务删除成功！');
                        location.reload();
                    } else {
                        alert('任务删除失败：' + data.message);
                    }
                })
                .catch(error => {
                    alert('操作失败：' + error.message);
                });
            }
        }
    </script>
</body>
</html>
